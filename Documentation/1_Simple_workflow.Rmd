---
title: "A simple workflow for IsoriX"
author: "The IsoriX core team"
date: "`r Sys.Date()`"
output:
    pdf_document
vignette: >
  %\VignetteIndexEntry{1_Simple_workflow}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, initialization, echo=FALSE}
library(knitr)
set.seed(123)  ## set seed for entire manuscript
# set global options for knitr (if changed, all cashed chunked will be rerun!)
knitr::opts_chunk$set(cache = TRUE, cache.path = "./cache/cache_knitr/chapter1/", fig.path = "./cache/fig_knitr/chapter1/", global.par = TRUE, fig.align = "center", error = TRUE) # use dpi=100 for small pdfs
docache <- TRUE
```



## Step 7 - Fit the calibration function

In this example, we will use the calibration dataset `CalibDataBat` that is provided with __IsoriX__. This dataset concerns sedentary bats inhabiting Europe (see `?CalibDataBat` for details). We now use the function `calibfit()` to fit the relationship between the isotope values in the environment and the isotope values in our calibration organisms:

```{r calib}
calib <- calibfit(calib.data = CalibDataBat, isofit = Europefit)
```

These warnings should disappear in the future. They reflect limitations of the current version of the package __spaMM__, which we use to fit our models.

To get the result of the calibration fit, you can simply type the name of the object we just created, or plot it:

```{r calib2, fig.asp = 1}
calib
plot(calib)
```

\newpage

## Step 8 - Perform the assignment

We will now perform the assignment procedure that aims at identifying areas with the same isotopic signature than the area where individuals originate. To put this into practice, we will use a dataset containing isotopic measurements on other bats, which is also provided in __IsoriX__. We will select from this dataset the bats of the species "Myotis_bechsteinii":

```{r assign data}
M_bechsteinii <- subset(AssignDataBat, species == "Myotis_bechsteinii")
M_bechsteinii
```

We now perform the assignment using our function `isofind()`:

```{r assign comput}
assignment <- isofind(assign.data = M_bechsteinii, isoscape = isoscape, calibfit = calib)
```

Note that by default the function `isofind()` exclude with certainty that the origin of the bats could come from the water.

```{r save assignment, echo = FALSE}
save(assignment, file = "./output/assignment.rda", compress = "xz")
```

Once the assignment done, you can draw several assignment maps. Let us start by plotting the assignment map for a specific bat by telling the function `plot` that `who` we want the plot for the bat with the `animalID` "Mbe_6" for example:

```{r assign_plot1}
plot(x = assignment, who = "Mbe_6")
```

\newpage

We can also use number for individuals and plot several at once:

```{r assign_plot2}
plot(x = assignment,
     who = 1:9,
     sources = list(draw = FALSE),
     calib = list(draw = FALSE))
```

Note that we removed the plotting of sources and calibration points in the previous plot by setting using `draw = FALSE`.

Assuming that all bats originate from the same place we can also plot the global assignment for the group by setting `who = "group"`:

```{r assign_plot3}
plot(x = assignment, who = "group")
```

We can easily add information on these plots. As an example, we will add the point that is the most compatible with the unknown origin of these bats. We start by extracting its location using functions from the package __raster__:

```{r maximum}
coord <- coordinates(assignment$group$pv)
max.location <- coord[which.max(values(assignment$group$pv)), ]
maximum <- data.frame(long = max.location[1], lat = max.location[2])
maximum
```

Let us also compute for comparison the point that corresponds to the real origin of bats. We know it because they were caught in a cave in the North of Bulgaria:

```{r, origin}
origin <- data.frame(long = 25.982122, lat = 43.611536)
```

You can plot these information on top of the last plot we created by means of the package __lattice__:

```{r assign_plot4, message = FALSE}
library(lattice)
trellis.last.object() + 
  xyplot(origin$lat~origin$long, pch = 13, col = "purple", cex = 5, lwd = 2, 
      panel = panel.points) +
  xyplot(maximum$lat~maximum$long, pch = 13, col = "orange", cex = 5, lwd = 2, 
      panel = panel.points)
```

The function `trellis.last.object()` is very handy: it retrieves the last plot created using __lattice__ and our plot functions for isoscapes and assignments use __lattice__ since they use __rasterVis__, which is a package itself based on __lattice__.

As you can see the location of origin (purple) and the location for the best assignment (orange) differ a bit. The flexibility of __IsoriX__ helps to explore potential sources of problems and limitation. We can for example compare our isoscape prediction in these two locations:

```{r comparison}
print(paste("mean isoscape value at origin (+/-SE) =",
            round(extract(isoscape$isoscape$mean, origin), 2), "+/-",
            round(sqrt(extract(isoscape$isoscape$mean.predVar, origin)), 2)))

print(paste("mean isoscape value at maximum (+/-SE) =",
            round(extract(isoscape$isoscape$mean, maximum),2), "+/-",
            round(sqrt(extract(isoscape$isoscape$mean.predVar, maximum)), 2)))
```

Note that the estimate for the mean isotopic value where the maximum is has a large standard error as this area is not well covered by sources. You can also observe this effect by simply looking at the map for the prediction isoscape variance which we have plotted above. In this context, it is thus expected that such area will be difficult to rule out as a possible source of origin. This example is a good reminder that one must always think about the quality of the isoscape before drawing definitive biological conclusion.

Another way to look at our assignment is to check if for all bats the predicted assignment region does include the real location of origin (which is possible because here we do know what the real origin of the bats is). To do so, we start by extracting the p-values of the assignment at the location of origin for all individuals:

```{r ground truthing}
pvs <- c(extract(assignment$indiv$pv, origin))
```

We can then count for how many bats the true origin location is not rejected by our assignment test:

```{r ground truthing 2}
table(pvs > 0.05)
```

All bats are in! That is great but it will not necessarily happen all the time, especially if as here the calibration is performed on a different species than the individuals you want to allocate. As an exercise you can now try to plot the bats we assigned into the calibration fit to see if they do behave in the same way as other species.

## Next?

For other tutorials on __IsoriX__, check the other vignettes we created for you by simply typing:

```{r vignette, eval = FALSE}
browseVignettes(package ='IsoriX')
```

Please note that the number and the quality of the vignettes keeps growing with updates of __IsoriX__. So keep updating your packages in R and check what has been changing between two versions by typing:

```{r news, eval = FALSE}
news(package = 'IsoriX')
```

## The End

That is all for now! Here are the information of the R session we used:

```{r R session}
sessionInfo()
```
