---
title: "How to export to GIS in IsoriX?"
author: "Alexandre Courtiol, FranÃ§ois Rousset & Stephanie Kramer-Schadt"
date: '`r Sys.Date()`'
output:
  pdf_document
vignette: >
  %\VignetteIndexEntry{Export to GIS in IsoriX}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, initialization, echo=FALSE, results='hide', message=FALSE}
library(knitr)
library(IsoriX)
library(raster)
# set global options for knitr (if changed, all cashed chunked will be rerun!)
knitr::opts_chunk$set(cache=TRUE, cache.path="./cache_knitr/", fig.path="./fig_knitr/", global.par=TRUE, width="\\linewidth", fig.align="center", dev="CairoPNG", dpi=500) # use dpi=100 for small pdfs
do.eval <- TRUE ## to check that it does work, put TRUE
```

Welcome to __IsoriX__, in this vignette we present the steps required for you to export the spatial object created in IsoriX to your favorite GIS software.

# Before starting

Please read the vignette ___Workflow___, if you haven't done so. You can access it by simply typing:

```{r, workflow, eval=FALSE}
vignette("Workflow", package="IsoriX")
```

We assume that you are still in the same R session than the one created during the simple workflow example. That implies that the packages __IsoriX__ and __raster__ are loaded and that the objects we will use below have already been created.


```{r, load isoscape, echo=FALSE, message=FALSE, results='hide'}
data(countries)
data(oceanmask)
data(Europefit)
load("../vignette_workflow/isoscape.rda")
load("../vignette_workflow/assignment.rda")
elevationraster <- raster("../vignette_workflow/gmted2010_30mn.tif")
elev <- relevate(elevation.raster=elevationraster, isofit=Europefit, aggregation.factor=10)
```

You can test if you have all the object we need by running the following code:

```{r test if objects are here}
all(c("countries", "oceanmask", "elev", "isoscape", "assignment") %in% ls())
```

If the result is TRUE, you can proceed! If not, then go back to the vignette ___Workflow___.


# Export your data to a GIS

R comes along with a suite of free packages designed for easy handling of spatial data and exchange formats with standard GIS programs, such asArcGIS by ESRI. Although you can probably do all you need in R, we will how you can export the different spatial object created in IsoriX to your favorite GIS software.

Let's first explain which spatial data formats we use in IsoriX and where to find the spatial data in the objects created by IsoriX.

## RasterLayers, RasterStacks (RasterBricks),  and SpatialPolygons, SpatialPointsDataFrames

There are four types of spatial objects in IsoriX that one should know about. RasterLayers are 2-dimensional matrix-like grids, with each grid cell containing a value representing information, e.g. the mean predicted isotopic value or elevation. RasterStacks or RasterBricks are multilayer-raster objects, i.e. multi-band satellite images (see __raster__ package).
SpatialPolygons and SpatialPoints are vector-data, i.e. geometric objects of polygons, (lines) or points and can be handled through the __sp__ package.

## Accessing the spatial information stored in the objects of class *isoscape* and *isorix*

The object 'countries' and the 'oceanmask' are ready-to-use polygon vector layers stored in IsoriX as SpatialPolygons. Further spatial information is stored in the objects of class *isoscape* (such as isoscape) and *isorix* (such as assignment).

### The guts of the objects of class *isoscape*

The objects of class *isoscape* (such as the object actually called ```isoscape``` which we created in the workflow) are list that contain information stored in ```$isoscape``` (a RasterStack) and ```$sp.points``` (a list containing itself ```$sources``` a SpatialPointsDataFrame). All of this can be deduced from the analysis of the object in R:

```{r AccessIsoscape1}
names(isoscape)
class(isoscape$isoscape)
class(isoscape$sp.points$sources)
```

The RasterStack consists of 8 layers specified in the names-slot:
```{r AccessIsoscape2}
names(isoscape$isoscape) 
```

To access a single RasterLayers, e.g. to plot or export it, just type:
```{r AccessIsoscape3}
isoscape$isoscape$mean ## similar to: isoscape$isoscape[[1]] or isoscape$isoscape[["mean"]]
```
In a similar way, you can access the weather station data, called sources:
```{r AccessIsoscape4}
isoscape$sp.points$sources
```

### The guts of the objects of class *isorix*

Analoguously, one can access all the information stored in the object of class *isorix*. Here, for each statistical output (e.g. p-value), a RasterBrick is stored containing the information for each single individual entered into the assignment dataset:

```{r AccessIsorix1}
names(assignment)
names(assignment$indiv)
names(assignment$indiv$pv)
```

That is, the assignment probability of e.g. a given individual 'Mbe_1' can be extracted from the RasterBrick ```$indiv$pv``` in the following way:

```{r AccessIsorix2}
assignment$indiv$pv$Mbe_1 ## similar to: assignment$indiv$pv[["Mbe_1"]]
```

The objects of class *isorix* also store the sources (e.g. water stations used to create the isoscape) as well as the locations of the calibrationdata as SpatialPointsDataFrames and can be accessed accordingly:

```{r AccessIsorix3}
assignment$sp.points$sources
assignment$sp.points$calibs
```


## Export spatial objects created in IsoriX 

The ESRI shapefile is a widely used interchange format to store vector data, i.e. in our case the SpatialPolygons (countries, oceanmask) and the SpatialPointsDataFrames (sources, calibration locations). There are two libraries in R that can be used to create such shapefile: ```rgdal``` and ```maptools``` (https://www.nceas.ucsb.edu/scicomp/usecases/ReadWriteESRIShapeFiles). To save SpatialPolygons, a little workaround is needed to add an attribute. Before the export, make sure that the projection is defined for all spatial data. By default, we are working with WGS84.


```{r ExportShape, tidy.opts=list(keep.blank.line=FALSE, width.cutoff=60)}
## the sources
SourceLocations <- assignment$sp.points$sources
projection(SourceLocations)

## workaround for countries
df <- data.frame(id = getSpPPolygonsIDSlots(countries)) ## create table with 'id'
row.names(df) <- getSpPPolygonsIDSlots(countries)
wrld_cntrs <- SpatialPolygonsDataFrame(countries, data = df)
projection(wrld_cntrs)

## export in your current directory
library(rgdal)
writeOGR(
  obj = SourceLocations,
  dsn = getwd(),
  layer = 'SourceLocs_rgdal',
  driver = 'ESRI Shapefile',
  overwrite = TRUE
  )

  writeOGR(
  obj = wrld_cntrs,
  dsn = getwd(),
  layer = 'SourceLocs_rgdal',
  driver = 'ESRI Shapefile',
  overwrite = TRUE
  )

library(maptools)
writePointsShape(x=SourceLocations, "SourceLocs_mapt") #points
writePolyShape(x=wrld_cntrs, "worldcntrs_mapt") #polygons

```

RasterLayers can be exported with the __raster__ package as ascii format or geotiff. More raster formats are available, depending on the GIS-system you have. e.g. SAGA, IDRISI or Erdas Imagine (type ?writeRaster)
```{r ExportRaster,eval=FALSE,tidy.opts=list(keep.blank.line=FALSE, width.cutoff=60)}
Assignment_Prob_Mbe_1 <- assignment$indiv$pv[['Mbe_1']]
projection(Assignment_Prob_Mbe_1)

writeRaster(Assignment_Prob_Mbe_1, filename="ap1.asc",format="ascii",overwrite=TRUE,NAflag = -9999)
writeRaster(Assignment_Prob_Mbe_1, filename="ap2.tif",format="GTiff",overwrite=TRUE,NAflag = -9999)#requires rgdal
```
